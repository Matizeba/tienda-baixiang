<style>
    .modalSale {
        max-width: 65%;
        width: auto;
    }
</style>
dd($request->all());

@extends('layouts.app')

@section('content')
<div class="container">
    <h2>Crear Venta</h2>

    <div class="row mb-3">
        <div class="col-md-6">
            <label for="customerSelect" class="form-label">Seleccionar Cliente</label>
            <select id="customerSelect" class="form-select">
                <option value="">Seleccione un cliente</option>
                @foreach($customers as $customer)
                    <option value="{{ $customer->id }}">{{ $customer->name }}</option>
                @endforeach
            </select>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cartModal">
                <i class="fas fa-shopping-cart"></i> Carrito <span class="badge bg-secondary" id="cartCount">0</span>
            </button>
        </div>
    </div>

    <div class="mb-3">
        <label for="productSelect" class="form-label">Seleccionar Producto</label>
        <select id="productSelect" class="form-select" onchange="updateUnits()">
            <option value="">Seleccione un producto</option>
            @foreach($products as $product)
                <option value="{{ $product->id }}">{{ $product->name }}</option>
            @endforeach
        </select>
    </div>

    <table id="unitsTable" class="table">
        <thead>
            <tr>
                <th>Unidad</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Cantidad Disponible</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <!-- Las unidades se llenarán aquí según el producto seleccionado -->
        </tbody>
    </table>

    <!-- Modal para confirmar la cantidad -->
    <div class="modal fade" id="confirmQuantityModal" tabindex="-1" aria-labelledby="confirmQuantityModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmQuantityModalLabel">Confirmar Cantidad</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Producto: <span id="confirmProductName"></span></p>
                    <p>Descripción: <span id="confirmDescription"></span></p>
                    <p>Precio: <span id="confirmPrice"></span></p>
                    <label for="confirmQuantityInput" class="form-label">Cantidad:</label>
                    <input type="number" id="confirmQuantityInput" class="form-control" min="1" value="1" oninput="checkQuantity(this)">
                    <p>Total: <span id="confirmTotal"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="addToCartButton">Añadir al Carrito</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal del carrito -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
        <div class="modal-dialog modalSale">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cartModalLabel">Carrito de Compras</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table id="cartTable" class="table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Unidad</th>
                                <th>Descripción</th>
                                <th>Precio</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Aquí se agregarán los artículos seleccionados -->
                        </tbody>
                    </table>
                    <h5>Total General: <span id="grandTotal">0.00</span></h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="confirmSaleButton">Confirmar Venta</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    var cart = []; // Array para almacenar los productos seleccionados

    function updateUnits() {
        var productId = document.getElementById('productSelect').value;
        var unitsTableBody = document.getElementById('unitsTable').getElementsByTagName('tbody')[0];
        unitsTableBody.innerHTML = ''; // Limpiar la tabla

        @foreach($products as $product)
            if (productId == "{{ $product->id }}") {
                @foreach($product->productUnits as $productUnit)
                    var row = unitsTableBody.insertRow();
                    row.insertCell(0).innerText = "{{ $productUnit->unit->name }}";
                    row.insertCell(1).innerText = "{{ $productUnit->unit->description }}";
                    row.insertCell(2).innerText = "{{ $productUnit->price }}";
                    row.insertCell(3).innerText = "{{ $productUnit->stock }}";

                    // Agregar botón para añadir al carrito
                    var addButton = document.createElement('button');
                    addButton.innerText = 'Añadir';
                    addButton.className = 'btn btn-success btn-sm';
                    addButton.onclick = (function(unit, price, productName, description, stock) {
                        return function() {
                            openConfirmModal(unit, price, productName, description, stock);
                        };
                    })("{{ $productUnit->unit->name }}", "{{ $productUnit->price }}", "{{ $product->name }}", "{{ $productUnit->unit->description }}", "{{ $productUnit->stock }}");
                    var cell = row.insertCell(4);
                    cell.appendChild(addButton);
                @endforeach
            }
        @endforeach
    }

    function openConfirmModal(unit, price, productName, description, stock) {
        document.getElementById('confirmProductName').innerText = productName;
        document.getElementById('confirmDescription').innerText = description;
        document.getElementById('confirmPrice').innerText = price;

        var quantityInput = document.getElementById('confirmQuantityInput');
        quantityInput.value = 1; // Valor por defecto
        quantityInput.max = stock; // Establecer el máximo permitido
        updateTotal(quantityInput.value, price);

        // Manejar el cambio en el input para actualizar el total
        quantityInput.oninput = function() {
            checkQuantity(this, stock);
            updateTotal(quantityInput.value, price);
        };

        // Guardar el producto en el botón de añadir al carrito
        document.getElementById('addToCartButton').onclick = function() {
            if (isProductInCart(productName, unit)) {
                alert("Este producto ya está en el carrito.");
            } else {
                addToCart(unit, price, quantityInput.value, productName, description);
                $('#confirmQuantityModal').modal('hide'); // Cerrar el modal
            }
        };

        $('#confirmQuantityModal').modal('show'); // Mostrar el modal
    }

    function checkQuantity(input, stock) {
        var quantity = parseInt(input.value);
        if (quantity > stock) {
            input.value = stock; // No permitir más que el stock disponible
            alert("No se puede seleccionar más de " + stock + " unidades.");
        }
    }

    function updateTotal(quantity, price) {
        var total = quantity * price;
        document.getElementById('confirmTotal').innerText = total.toFixed(2); // Mostrar el total formateado
    }

    function addToCart(unit, price, quantity, productName, description) {
        // Añadir el artículo al carrito
        cart.push({ productName: productName, unit: unit, description: description, price: price, quantity: quantity });

        // Actualizar la tabla del carrito
        updateCartTable();
        updateCartCount();
    }

    function updateCartTable() {
        var cartTableBody = document.getElementById('cartTable').getElementsByTagName('tbody')[0];
        cartTableBody.innerHTML = ''; // Limpiar la tabla
        var grandTotal = 0;

        cart.forEach((item, index) => {
            var row = cartTableBody.insertRow();
            row.insertCell(0).innerText = item.productName;
            row.insertCell(1).innerText = item.unit;
            row.insertCell(2).innerText = item.description;
            row.insertCell(3).innerText = item.price;
            row.insertCell(4).innerText = item.quantity;

            var total = item.price * item.quantity;
            grandTotal += total;
            row.insertCell(5).innerText = total.toFixed(2); // Total para este producto

            // Agregar botón para eliminar del carrito
            var removeButton = document.createElement('button');
            removeButton.innerText = 'Eliminar';
            removeButton.className = 'btn btn-danger btn-sm';
            removeButton.onclick = function() {
                removeFromCart(index);
            };
            row.insertCell(6).appendChild(removeButton);
        });

        document.getElementById('grandTotal').innerText = grandTotal.toFixed(2); // Mostrar total general
    }

    function removeFromCart(index) {
        cart.splice(index, 1); // Eliminar del carrito
        updateCartTable(); // Actualizar la tabla
        updateCartCount(); // Actualizar el contador
    }

    function isProductInCart(productName, unit) {
        return cart.some(item => item.productName === productName && item.unit === unit);
    }

    function updateCartCount() {
        document.getElementById('cartCount').innerText = cart.length;
    }

    document.getElementById('confirmSaleButton').onclick = function() {
        if (cart.length === 0) {
            alert("El carrito está vacío. No se puede confirmar la venta.");
            return;
        }

        // Aquí puedes agregar el código para enviar los datos de la venta al servidor
        alert("Venta confirmada con éxito!"); // Mensaje de éxito
        cart = []; // Vaciar el carrito
        updateCartTable(); // Actualizar tabla
        updateCartCount(); // Actualizar contador
        $('#cartModal').modal('hide'); // Cerrar modal del carrito
    };
</script>
@endsection